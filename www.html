<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<link rel="stylesheet" type="text/css" href="./canvas.css">

<body>
    <div class="eseal-all">
        <div class="eseal-name">
            <b>公司印章制作</b>
            <span>(单位为毫米)</span>
        </div>
        <div>
            <ul>
                <h3>
                    画布设置
                </h3>
                <li class="seal">
                    <span class="seal-name"> 画布大小: </span>
                    <input class="seal-input" id="canvasSize" width="150" type="text" value='60' />
                </li>
                <li class="seal">

                    <span class="seal-name"> 外边框线宽: </span>
                    <input class="seal-input" id="lineWidth" width="150" type="text" value='1.2' />
                </li>
                <li class="seal">

                    <span class="seal-name"> 内边框线宽: </span>
                    <input class="seal-input" id="innerLineWidth" width="150" type="text" value='0.5' />
                </li>
                <li class="seal">
                    <span class="seal-name"> 边线选择 ： </span>
                    <input class=" checke " name="hasInnerLine" type="radio" class="hasInnerLine" value='1' /><span>双线边框</span>
                    <input class="  checke" name="hasInnerLine" type="radio" class="hasInnerLine" value='0' checked /><span>单线边框</span>
                </li>



            </ul>

            <ul>
                <h3>
                    公司名称设置
                </h3>
                <li class="seal">
                    <span class="seal-name"> 公司名称： </span>
                    <input class="seal-input" id="companyName" width="150" type="text" value='北京市人民政府' />
                </li>
                <li class="seal">
                    <span class="seal-name"> 公司文字大小 ： </span>
                    <input class="seal-input" id="companyNameFontSize" width="150" type="text" value='17' />
                </li>
                <li class="seal">
                    <span class="seal-name"> 公司文字间距 ：</span>
                    <input class="seal-input" id="companyWidth" width="150" type="text" value='34' />
                </li>
                <li class="seal">
                    <!-- 文字与外边框线的距离:-->
                    <span class="seal-name"> 文字与中心点的距离: </span>
                    <input class="seal-input" id="lineTextGap" width="150" type="text" value='8' />
                </li>
                <li class="seal">
                    <!-- 文字环排角度（夹角-->
                    <span class="seal-name"> 文字环排角度： </span>
                    <input class="seal-input" id="mathP" width="150" type="text" value='260' />
                </li>
                <li class="seal">
                    <!-- 文字环排角度（夹角-->
                    <span class="seal-name"> 文字环排角度： </span>
                    <input class="seal-input" id="mathPP" width="150" type="text" value='20' />
                </li>
                <li class="seal">

                </li>

            </ul>
            <ul>
                <h3>
                    印章名称设置
                </h3>
                <li class="seal">
                    <span class="seal-name"> 印章名称： </span>
                    <input class="seal-input " id="typeName" width="150" type="text" value='采购专用章' />
                </li>

                <li class="seal">
                    <span class="seal-name"> 印章名称文字大小 ： </span>
                    <input class="seal-input" id="typeNameFontSize" width="150" type="text" value='15' />
                </li>
                <li class="seal">
                    <span class="seal-name"> 印章名称文字间距 ： </span>
                    <input class="seal-input" id="typeNameMaxWidth" width="150" type="text" value='65' />
                </li>
                <li class="seal">
                    <span class="seal-name"> 印章名称位置 ： </span>
                    <input class="seal-input" id="locationA" width="150" type="text" value='38' />
                </li>
            </ul>
            <ul>
                <h3>
                    图案设置
                </h3>
                <li class="seal">
                    <!-- 五角星位置: -->
                    <span class="seal-name"> 偏移单位: </span>
                    <input class="seal-input" id="starY" width="150" type="text" value='8' />
                </li>
            </ul>
            <ul>
                <h3>
                    防伪码设置
                </h3>
                <li class="seal">
                    <span class="seal-name"> 防伪码： </span>
                    <input class="seal-input" id="securityCode" width="150" type="text" value='1234567890123' />
                </li>
                <li class="seal">
                    <span class="seal-name"> 防伪码文字大小 ： </span>
                    <input class="seal-input" id="securityCodeFontSize" width="150" type="text" value='9.2' />
                </li>
                <li class="seal">

                </li>
                <li class="seal">

                </li>
                <li class="seal">

                </li>
            </ul>
        </div>



    </div>

    <div class="eseal">
        <div id="tuzhangdiv">
            <canvas id="canvas"></canvas>
        </div>
        <div class="seal-bt">
            <span class="seal-btn" type="button" onclick="javascript:createSealEx();">生成公章
            </span>
            <span class="seal-btn" type="button" onclick="javascript: downLoadImage();">save</span>
        </div>
    </div>
    </div>

</body>
<style>
</style>
<script>
    var canvasSize
    var lineWidth
    var innerLineWidth
    // 文字与外边框线的距离
    var lineTextGap
    //五角星位置
    var starY

    var companyNameLength
    var companyNameFontSize
    var radius
    var hasInnerLine
    var companyName
    var typeName
    var securityCode
    var typeNameFontSize
    var typeNameMaxWidth
    var locationA
    var fontFamily
    var color

    var companyWidth
    var securityCodeFontSize
    // var dpii


    function createSealEx() {
        //印章大小设置
        // dpii = window.screen.height
        // alert(dpii)
        canvasSize = new unitConversion().mmConversionPx(document.getElementById('canvasSize').value);
        // 边框线的宽度
        lineWidth = new unitConversion().mmConversionPx(document.getElementById('lineWidth').value);
        // 内边框线的宽度
        innerLineWidth = new unitConversion().mmConversionPx(document.getElementById('innerLineWidth').value);
        // 文字与外边框线的距离
        lineTextGap = document.getElementById('lineTextGap').value / 10
        companyNameLength = true
        companyNameFontSize = document.getElementById('companyNameFontSize').value
        radius = canvasSize / 2
        var star = document.getElementById('starY').value
        starY = parseInt(radius) - parseInt(star)
        // alert(starY)
        hasInnerLine = document.getElementsByName('hasInnerLine')[0].checked ? '1' : '0'
        companyName = document.getElementById('companyName').value
        typeName = document.getElementById('typeName').value
        securityCode = document.getElementById('securityCode').value
        typeNameFontSize = document.getElementById('typeNameFontSize').value
        typeNameMaxWidth = document.getElementById('typeNameMaxWidth').value
        locationA = document.getElementById('locationA').value
        fontFamily = 'Arial'
        color = '#e60021'

        companyWidth = document.getElementById('companyWidth').value
        securityCodeFontSize = document.getElementById('securityCodeFontSize').value
        _init()
        saveSealImg()
    }

    function _init() {
        // alert(canvasSize)
        var canvas = document.getElementById('canvas')
        var ctx = canvas.getContext('2d');
        canvas.width = canvasSize
        canvas.height = canvasSize
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        _drawOuterLine();
        if (hasInnerLine === '1') {
            _drawInnerLine();
        }
        create5star(radius, starY, 25, 0);
        if (companyName) {
            _drawCompanyName();
        }
        if (typeName) {
            _drawTypeName();
        }
        if (securityCode) {
            _drawSecurityCode();
        }
    }


    //毫米转像素
    //调用直接 new unitConversion().pxConversionMm(像素) 
    //        new unitConversion().mmConversionPx (毫米)      
    // new unitConversion().pxConversionMm(227)
    // new unitConversion().mmConversionPx(60)
    function unitConversion() {
        /**
         * 获取DPI
         * @returns {Array}
         */
        this.conversion_getDPI = function () {
            var arrDPI = new Array;
            if (window.screen.deviceXDPI) {
                arrDPI[0] = window.screen.deviceXDPI;
                arrDPI[1] = window.screen.deviceYDPI;


            } else {
                var tmpNode = document.createElement("DIV");
                tmpNode.style.cssText = "width:1in;height:1in;position:absolute;left:0px;top:0px;z-index:99;visibility:hidden";
                document.body.appendChild(tmpNode);
                arrDPI[0] = parseInt(tmpNode.offsetWidth);
                arrDPI[1] = parseInt(tmpNode.offsetHeight);
                tmpNode.parentNode.removeChild(tmpNode);
            }
            console.log(arrDPI, 'dpi')
            return arrDPI;
        };
        /**
         * px转换为mm
         * @param value
         * @returns {number}
         */
        this.pxConversionMm = function (value) {
            var inch = value / this.conversion_getDPI()[0];
            var c_value = Math.round(inch * 25.4);
            console.log(c_value, 'mm');
            return c_value;
        };
        /**
         * mm转换为px
         * @param value
         * @returns {number}
         */
        this.mmConversionPx = function (value) {
            var inch = value / 25.4;
            var c_value = Math.round(inch * this.conversion_getDPI()[0]);
            console.log(c_value, 'px');
            return c_value;
        }
    }
    function saveSealImg() {
        var canvas = document.getElementById('canvas')

        // console.log(canvas.width)
        var URL = canvas.toDataURL();
        // console.log(canvas.width)
        // childByValue是在父组件on监听的方法
        // 第二个参数this.childValue是需要传的值
        return canvas.toDataURL();
    }
    function downLoadImage() {
        var canvas = document.getElementById('canvas')
        var a = document.createElement("a");
        a.href = canvas.toDataURL();
        a.download = 'ship.png';
        a.click();
    }
    function _drawCompanyName() {
        if (companyName.length > 19) {
            companyNameLength = false
            alert('公司名称最多只能为19个字符！')
            // throw new RangeError('公司名称最多只能为19个字符！');
            return
        }
        //公司名称
        _drawText(companyName, companyNameFontSize, false, false, false);
    }

    function _drawTypeName() {
        if (typeof typeName !== 'string') {
            companyNameLength = false
        }
        //印章名称
        _drawText(typeName, typeNameFontSize, true, false, true);
    }

    function _drawSecurityCode() {

        //  if () {
        //    //  alert('d')
        //    companyNameLength = false
        //    //  throw new TypeError('防伪码只能为字符串！');
        //  }
        if (securityCode.length > 0) {
            if (securityCode.length != '13' || typeof securityCode !== 'string') {
                alert('防伪码只能为13位！')
            } else {
                companyNameLength = true
            }
        }
        //防伪码
        _drawText(securityCode, securityCodeFontSize, false, true, true);
    }

    function _drawText(text, fontSize, isTypeName, isSecurityCode, isTextBaseline) {
        var canvas = document.getElementById('canvas')
        var ctx = canvas.getContext('2d');
        var i, letter;
        ctx.save();
        ctx.fillStyle = color;
        ctx.font = 'normal normal bold ' + fontSize + 'px ' + fontFamily;
        ctx.textBaseline = 'middle'; //法在画布上定位文本时
        //  if (isTextBaseline) {
        //    ctx.textBaseline = 'middle'; //法在画布上定位文本时
        //  } else {
        //    var textWidth = ctx.measureText(text).width
        //    console.log(textWidth)
        //  }
        //印章名称=true,公司，防伪码=false
        if (isTypeName) {
            ctx.textAlign = 'center';
        } else {
            ctx.textAlign = 'center';
            //  ctx.textAlign = 'left';
        }
        //76.5,76.5
        ctx.translate(radius, radius);
        //印章名称=true,公司，防伪码=false
        if (isTypeName) {
            //印章名称
            var charactHeight = locationA
            ctx.fillText(text, 0, charactHeight, typeNameMaxWidth);
            //  ctx.fillText(text, 0, radius / 2);
        } else {
            //公司，防伪码
            for (i = 0; i < text.length; i++) {
                letter = text[i];
                if (isSecurityCode) {
                    //防伪码
                    _drawLetter(letter, 0.57 - i * 0.1, -securityCodeFontSize / 2, radius * 0.8, 20, false);
                } else {
                    //公司名称
                    // 字数
                    var startIndex = companyName.length - 1;
                    // 字与字之间相差的弧度
                    //总度数
                    var math = document.getElementById('mathP').value
                    var mathPI = (parseInt(math) / 360) * Math.PI * 2
                    // alert(mathPI)
                    // var step = 10.8 * Math.PI / 9
                    var step = parseInt(mathPI) / startIndex
                    // alert(step)
                    _drawLetter(letter, i * step, -fontSize / 2, -radius * lineTextGap, companyWidth, true);
                    // console.log(-radius * lineTextGap)
                    //  _drawCompanyName()
                }
            }
        }
        ctx.restore();
    }

    function _drawLetter(letter, angle, x, y, maxwidth, isTranslate) {

        var canvas = document.getElementById('canvas')
        var ctx = canvas.getContext('2d');
        //  公司名称
        if (isTranslate) {
            ctx.save();
            ctx.rotate(angle);
            // alert(angle)
            var math = document.getElementById('mathPP').value
            // 40 15
            //控制文字离中心点的位置，往左、往上为负值，以画布的一半作为计算
            ctx.translate(-70, math); // 平移到此位置,此时字和x轴垂直，第一个参数是与圆外边的距离，越大距离越近
            var math = document.getElementById('mathP').value
            var mathPI = (parseInt(math) / 360) * Math.PI
            ctx.rotate(mathPI * 2); // 文字旋转,让字平行于x轴
            ctx.fillText(letter, 0, 0, maxwidth); // 此点为字的中心点 //
            //  ctx.fillText(letter, -45, 25); // 此点为字的中心点 //
            //maxWhdthNum
            ctx.restore();
            //  }
        } else {
            ctx.save();
            ctx.rotate(angle);
            ctx.fillText(letter, 0, y, maxwidth);
            ctx.restore();
        }
    }

    function create5star(sx, sy, radius, rotato) {
        var canvas = document.getElementById('canvas')
        var ctx = canvas.getContext('2d');
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = innerLineWidth;
        ctx.fillStyle = color;
        ctx.translate(sx, sy); //移动坐标原点
        ctx.rotate(Math.PI + rotato); //旋转
        ctx.beginPath(); //创建路径
        var x = Math.sin(0);
        var y = Math.cos(0);
        var dig = Math.PI / 5 * 4;
        for (var i = 0; i < 5; i++) { //画五角星的五条边  
            var x = Math.sin(i * dig);
            var y = Math.cos(i * dig);
            ctx.lineTo(x * radius, y * radius);
        }
        ctx.closePath();
        ctx.stroke();
        ctx.fill();
        ctx.restore();
    }
    //外边线
    function _drawOuterLine() {
        var canvas = document.getElementById('canvas')
        var ctx = canvas.getContext('2d');
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = lineWidth;
        ctx.beginPath();
        ctx.arc(radius, radius, radius - lineWidth, 0, Math.PI * 2, true);
        ctx.stroke();
        ctx.restore();
    }
    //内边线
    function _drawInnerLine() {
        var canvas = document.getElementById('canvas')
        var ctx = canvas.getContext('2d');
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = innerLineWidth;
        ctx.beginPath();
        ctx.arc(radius, radius, radius - lineWidth - radius / 15, 0, Math.PI * 2, true);
        ctx.stroke();
        ctx.restore();
    }
</script>

</html>